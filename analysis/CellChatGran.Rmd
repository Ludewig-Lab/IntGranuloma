---
title: "CellChatGran"
author: "A.DeMartin"
date: "2025-08-22"
output: 
  html_document:
    keep_md: true
    toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

#### load packages
```{r load packages}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Mm.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(here)
```

#### load merged file granuloma
```{r load merged file granuloma}
basedir <- here()
fileNam <- paste0(basedir, "/data/merged_allgranuloma_wofilter_seurat_wocl21.rds")
seurat <- readRDS(fileNam)
```

#### set color vectors
```{r set color vectors}
## col clustername
colclustername <- c("#355C7D","#B1746FFF","#202547","#B09C85", "#4e5a4c","#53354A","#2A363B","#8491B4FF","#00A087FF","#DC9989","#84ad83", "#628395","#D33B44","#779d8d","#727077","#868686FF","#F8B195","#FF847C","#725663FF","#904D39","#91D1C2")
names(colclustername) <- c("PdgfraloFb1","Mph1", "CD8Tcell1","Neut", "IgABcell1", "LEC", "Telocytes", "DC", "CD4Tcell/ILC2", "Mph2",  "NKcell", "CD8Tcell2", "Mph3", "Trophocytes", "PdgfrahiFb", "IgABcell2", "Myocytes", "PdgfraloFb2", "IgDBcell", "Glial", "ICC")

## col cond2
colcond2 <- c("#202547","#BE3144")
names(colcond2) <- c("WT", "cko")
```

### Cellchat interaction analysis 
#### load packages cellchat
```{r load packages cellchat}
library(CellChat)
library(patchwork)
options(stringsAsFactors = FALSE)
```

#### assign clusterLabel
```{r assign clusterLabel ext, eval=FALSE, include=TRUE}
seurat$clusterNameext <- "allCells"
seurat$clusterNameext[which(seurat$cluster_name == "CD8Tcell1")] <- "a_CD8Tcell1"
seurat$clusterNameext[which(seurat$cluster_name == "CD8Tcell2")] <- "b_CD8Tcell2"
seurat$clusterNameext[which(seurat$cluster_name == "NKcell")] <- "c_NKcell"
seurat$clusterNameext[which(seurat$cluster_name == "CD4Tcell/ILC2")] <- "d_CD4Tcell/ILC2"
seurat$clusterNameext[which(seurat$cluster_name == "Neut")] <- "e_Neut"
seurat$clusterNameext[which(seurat$cluster_name == "Mph1")] <- "f_Mph1"
seurat$clusterNameext[which(seurat$cluster_name == "Mph2")] <- "g_Mph2"
seurat$clusterNameext[which(seurat$cluster_name == "Mph3")] <- "h_Mph3"
seurat$clusterNameext[which(seurat$cluster_name == "DC")] <- "i_DC"
seurat$clusterNameext[which(seurat$cluster_name == "IgABcell1")] <- "j_IgABcell1"
seurat$clusterNameext[which(seurat$cluster_name == "IgABcell2")] <- "k_IgABcell2"
seurat$clusterNameext[which(seurat$cluster_name == "IgDBcell")] <- "l_IgDBcell"
seurat$clusterNameext[which(seurat$cluster_name == "PdgfraloFb1")] <- "m_PdgfraloFb1"
seurat$clusterNameext[which(seurat$cluster_name == "PdgfraloFb2")] <- "n_PdgfraloFb2"
seurat$clusterNameext[which(seurat$cluster_name == "Trophocytes")] <- "o_Trophocytes"
seurat$clusterNameext[which(seurat$cluster_name == "Telocytes")] <- "p_Telocytes"
seurat$clusterNameext[which(seurat$cluster_name == "Myocytes")] <- "q_Myocytes"
seurat$clusterNameext[which(seurat$cluster_name == "PdgfrahiFb")] <- "r_PdgfrahiFb"
seurat$clusterNameext[which(seurat$cluster_name == "Glial")] <- "s_Glial"
seurat$clusterNameext[which(seurat$cluster_name == "LEC")] <- "t_LEC"
seurat$clusterNameext[which(seurat$cluster_name == "ICC")] <- "u_ICC"
table(seurat$clusterNameext)
```

#### convert to sce to change rownames
```{r make sce, eval=FALSE, include=TRUE}
sce <- as.SingleCellExperiment(seurat)
rownames(sce) = gsub("^.*\\.","",rownames(sce))
```

#### create a CellChat object
```{r create CellChat object, eval=FALSE, include=TRUE}
cellchat <- createCellChat(object = sce, group.by = "clusterNameext")
```

#### set the ligand receptor interaction database
```{r set database, eval=FALSE, include=TRUE}
CellChatDB <- CellChatDB.mouse 
showDatabaseCategory(CellChatDB)
## show the structure of the database
dplyr::glimpse(CellChatDB$interaction)

## use all CellChatDB for cell-cell communication analysis
CellChatDB.use <- CellChatDB 

## set the used database in the object
cellchat@DB <- CellChatDB.use
cellchatcko@DB <- CellChatDB.use
cellchatwt@DB <- CellChatDB.use
```

#### processing expression data for cellcell communication analysis
```{r processing expression data, eval=FALSE, include=TRUE}
cellchat <- subsetData(cellchat) 
future::plan("multisession", workers = 4) 
options(future.globals.maxSize = 10000 * 1024^2)

cellchat <- identifyOverExpressedGenes(cellchat)
cellchat <- identifyOverExpressedInteractions(cellchat)
```

#### compute the communication probability and infer cellular communication network
```{r compute communication probability, eval=FALSE, include=TRUE}
cellchat <- computeCommunProb(cellchat, type =  "truncatedMean", trim= 0.1) ## set truncated mean to 10% - average gene expression is zero if less than 10% of cell in one group express gene (default is 25%)
```

#### infer the cell-cell communication at a signaling pathway level
```{r CommunProbPathwqy, eval=FALSE, include=TRUE}
cellchat <- computeCommunProbPathway(cellchat)
```

```{r aggregateNet, eval=FALSE, include=TRUE}
cellchat <- aggregateNet(cellchat)
```

#### compute the network centrality scores
```{r computeCentrality, eval=FALSE, include=TRUE}
future.seed=TRUE
cellchat <- netAnalysis_computeCentrality(cellchat, slot.name = "netP") 
```

```{r save CellChat object, eval=FALSE, include=TRUE}
## save chellchat object
saveRDS(cellchat, file =paste0(basedir, "/data/cellchat_allext.rds"))
```

### start downstream analysis
#### load chellchat object
```{r load cellchat object}
cellchat.all <- readRDS(paste0(basedir, "/data/cellchat_allext.rds"))
```

```{r setcolor vector}
colclusterName <- c("#202547","#628395","#84ad83","#779d8d","#B09C85","#B1746FFF","#DC9989"
                    ,"#D33B44","#8491B4FF","#4e5a4c","#727077","#725663FF","#355C7D","#FF847C"
                    ,"#779d8d","#2A363B","#F8B195","#868686FF","#904D39","#53354A","#91D1C2")
```

#### extract the inferred cellular communication network as a data frame
```{r extract interacitons}
df.net <- subsetCommunication(cellchat.all) ## returns a data frame consisting of all the inferred cell-cell communications at the level of ligands/receptors
```

#### calculate the aggregated cell-cell communication network
```{r signaling heatmap}
par(mfrow=c(1,1))
netVisual_heatmap(cellchat.all, color.heatmap = "GnBu", color.use = colclusterName, measure = "count")
netVisual_heatmap(cellchat.all, color.heatmap = "GnBu", color.use = colclusterName, measure = "weight")
```

### signaling pathway networks
#### OSM
```{r sender receiver OSM}
pathways.show <- c("OSM")
## Visualize the computed centrality scores using heatmap
netAnalysis_signalingRole_network(cellchat.all, signaling = pathways.show, width = 8, height = 2.5, font.size = 10, color.heatmap = "Blues", color.use = colclusterName)
```

#### IL1
```{r sender receiver IL1}
pathways.show <- c("IL1")
## Visualize the computed centrality scores using heatmap
netAnalysis_signalingRole_network(cellchat.all, signaling = pathways.show, width = 8, height = 2.5, font.size = 10, color.heatmap = "Blues", color.use = colclusterName)
```

#### session info
```{r date and session info}
date()
sessionInfo()
```
