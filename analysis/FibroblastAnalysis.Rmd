---
title: "FibroblastAnalysis"
author: "A.DeMartin"
date: "2025-08-28"
output: 
  html_document:
    keep_md: true
    toc: true
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
options(width = 100)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dev = c("png", "pdf"))
seed <- 1234
```

#### load packages
```{r load packages}
library(ExploreSCdataSeurat3)
library(runSeurat3)
library(Seurat)
library(ggpubr)
library(pheatmap)
library(SingleCellExperiment)
library(dplyr)
library(tidyverse)
library(viridis)
library(muscat)
library(circlize)
library(destiny)
library(scater)
library(metap)
library(multtest)
library(clusterProfiler)
library(org.Mm.eg.db)
library(msigdbr)
library(enrichplot)
library(DOSE)
library(grid)
library(gridExtra)
library(ggupset)
library(VennDiagram)
library(here)
```

#### load merged object allFb
```{r}
## load object merged allFb naive and d4
basedir <- here()
fileNam <- paste0(basedir, "/data/merged_allFb_naiveANDd4_seurat.rds")
seuratFb <- readRDS(fileNam)
```

#### exclude glial cells
```{r}
## filter glial cells
table(seuratFb$clustername)
seuratFb_noglial <- subset(seuratFb, clustername == "Glial", invert = TRUE)
table(seuratFb_noglial$clustername)

seuratFb <- seuratFb_noglial
```

#### set color vectors 
```{r}
colcond2 <- c("#202547","#BE3144")
names(colcond2) <- c("WT", "cko")

colcond3 <- c("#B45B5C","#628395","#BF782D")
names(colcond3) <- c("infectedD4", "naive", "granulomaD4")

colclustername <- c("#355C7D", "#8E9B97","#99B898","#E84A5F","#0F1F38","#F8B195","#727077","#FF847C","#C06C84")
names(colclustername) <- c("PdgfraloFb1" ,"PdgfraloFb2", "Trophocytes","PdgfraloFb3", "Telocytes","Myocytes", "Pdgfrahi", "PdgfraloFb4", "Thy1Fb")
```

#### counts
```{r}
table(seuratFb_noglial$orig.ident)
table(seuratFb_noglial$cond2)
```

### umaps
#### clustering
```{r umaps clustername}
Idents(seuratFb) <- seuratFb$clustername
table(seuratFb$clustername, seuratFb$cond2)

DimPlot(seuratFb, reduction= "umap", cols = colclustername)
DimPlot(seuratFb, reduction= "umap", cols = colclustername) + theme(legend.position = "none")
```

#### cond2
```{r umaps cond2}
Idents(seuratFb) <- seuratFb$cond2
table(seuratFb$cond2)
DimPlot(seuratFb, reduction= "umap", cols = colcond2, shuffle = TRUE)
DimPlot(seuratFb, reduction= "umap", cols = colcond2, shuffle = TRUE) + theme(legend.position = "none")
DimPlot(seuratFb, reduction= "umap", cols = colcond2, split.by = "cond2") + theme(legend.position = "none")
```

### abundances
```{r Fb abundance plot no glial}
## make count list according to cond3
datList <- NULL
for(con in unique(seuratFb$cond3)){
  seuratSub <- subset(seuratFb, cond3==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clustername)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(cond=con)
  datList[[con]] <- dat_con
}
dat_all <- do.call("rbind", datList)

##order x
ordX <-  c("naive", "infectedD4", "granulomaD4") 

## plot abundance
ggbarplot(dat_all, x= "cond", y= "percent", fill = "Var1", legend = "right", legend.titel = "clustername", ylab = "frequency", palette = colclustername) + scale_x_discrete(limits=ordX)

## make count list according to cond2 plus cond3
datList <- NULL
for(con in unique(seuratFb$cond2_plus_cond3)){
  seuratSub <- subset(seuratFb, cond2_plus_cond3==con)
  print(dim(seuratSub))
  dat_con <- as.data.frame(table(seuratSub$clustername)) %>%
  mutate(percent=Freq/ncol(seuratSub)) %>% mutate(cond=con)
  datList[[con]] <- dat_con
}
dat_all <- do.call("rbind", datList)

##order x
ordX <-  c("WT_naive", "cko_naive", "WT_infectedD4", "cko_infectedD4", "WT_granulomaD4", "cko_granulomaD4") 

## plot abundance
ggbarplot(dat_all, x= "cond", y= "percent", fill = "Var1", legend = "right", legend.titel = "clustername", ylab = "frequency", palette = colclustername) + scale_x_discrete(limits=ordX) + theme(axis.text.x = element_text(angle = 20, hjust=1))
```

### DE analysis
#### DE genes according to cond3
```{r, include=TRUE, eval=FALSE}
Idents(seuratFb) <- seuratFb$cond3
levels(seuratFb)

DEGenesFbcond3 <- FindAllMarkers(seuratFb, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) 

write.table(DEGenesFbcond3, 
            file= paste0(basedir, "/data/DEGenesFbcond3_noGlial.txt"),
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

#### load DE genes granuloma
```{r, fig.height=12, fig.width=12}
## load DEGenesFbcond3
DEGenesFbcond3 <- read.delim(paste0(basedir, "/data/DEGenesFbcond3_noGlial.txt"), header = TRUE, sep = "\t")
```

#### DE genes according to cond2
```{r, include=TRUE, eval=FALSE}
Idents(seuratFb) <- seuratFb$cond2
levels(seuratFb)

DEGenesFbcond2 <- FindAllMarkers(seuratFb, only.pos=T) %>% 
  dplyr::filter(p_val_adj < 0.01) 

write.table(DEGenesFbcond2, 
            file= paste0(basedir, "/data/DEGenesFbcond2_noGlial.txt"),
            sep="\t",
            quote=F,
            row.names=F,
            col.names=T)
```

#### load DE genes wt
```{r, fig.height=12, fig.width=12}
## load DEGenesFbcond2
DEGenesFbcond2 <- read.delim(paste0(basedir, "/data/DEGenesFbcond2_noGlial.txt"), header = TRUE, sep = "\t")
```

## Venn diagram
```{r Venn}
## load DEGenesFbcond2
DEGenesFbcond2 <- read.delim("/Users/immbio/Desktop/Project/Angelina/Cxcl13Hpb/data/DEGenesFbcond2.txt", header = TRUE, sep = "\t")

DEGenesFbcond2_1 <- DEGenesFbcond2  %>% dplyr::filter(cluster == "WT") 
DEGenesFbcond3_1 <- DEGenesFbcond3 %>% dplyr::filter(cluster == "granulomaD4")

##make Venn Diagram
x <- list(UpInWT=DEGenesFbcond2_1$gene,
          UpInGran=DEGenesFbcond3_1$gene)
library(VennDiagram)
venn.diagram(x, filename = "venn-4-diagram.png")
# Helper function to display Venn diagram
display_venn <- function(z, ...) {
  grid.newpage()
  venn_object <- venn.diagram (z, filename = NULL, ...)
  grid.draw (venn_object)
}
display_venn(x)
# change fill color and circles
display_venn(x, fill = c("#2166AC", "#B2182B"), lwd = 5, lty = 'blank')
## extract genes in intersections
library(gplots)
vTab <- venn(x)
# extract genes in intersections
vTab
# extract genes in intersections
DEGenesintersect <- DEGenesFbcond2_1 %>% dplyr::filter(gene %in% DEGenesFbcond3_1$gene) 
DEGenesintersect1 <- DEGenesFbcond2_1 %>% dplyr::filter(!(gene %in% DEGenesFbcond3_1$gene)) 
DEGenesintersect2 <- DEGenesFbcond3_1 %>% dplyr::filter(gene %in% DEGenesFbcond2_1$gene) 
```

### GSEA on intersect genes
```{r, fig.height=20, fig.width=12}
DEGenesintersect <- DEGenesintersect %>%
  mutate(Gene=gsub("^.*\\.", "", gene))  %>%
  mutate(EnsID=gsub("\\..*","", gene))

## GSEA
egointersect <- enrichGO(gene = unique(DEGenesintersect$EnsID),
                          OrgDb = org.Mm.eg.db,
                          keyType = 'ENSEMBL',
                          ont = "BP",
                          pAdjustMethod = "BH",
                          pvalueCutoff = 0.05,
                          qvalueCutoff = 0.05)
egointersect <- setReadable(egointersect, OrgDb = org.Mm.eg.db)
```

#### barplot GSEA intersect
```{r barplot GSEA intersect, fig.height=5, fig.width=12}
#select pahtways and filter file
selintersect <- c("response to interleukin-1", "positive regulation of cellular catabolic process", "negative regulation of endopeptidase activity", "cytokine-mediated signaling pathway")
egointersect_fil <- egointersect%>% filter(egointersect@result$Description %in% selintersect)

egointersect_fil_2 <- pairwise_termsim(egointersect_fil)
#make ggbarplot
p <- ggbarplot(egointersect_fil_2@result, x = "Description", y = "Count", fill = "#202547", color= "#202547", sort.val = "asc", orientation = "horizontal")
p
```

#### dotplot cytokine-mediated signling pathway 
```{r dotplot cytokine mediated signling pathway, fig.height=5, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("Ccl11","Ccl21a","Il1r1","Csf2rb2","Osmr","Il1r2","Jak3","Map3k7","Robo1", "Cyld", "Src", "Tslp", "Otud4", "Ptk2b"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
```

#### dotplot neg regualtion of endopepitdase activity
```{r dotplot neg regulation of endopeptidase activity, fig.height=3.5, fig.width=7}
genes <- data.frame(gene=rownames(seuratFb)) %>% 
  mutate(geneID=gsub("^.*\\.", "", gene))

selGenes <- data.frame(geneID=rev(c("Serpina3n", "Hspa1b","Serpina3g","Picalm","Xiap","Serpina3i", "Rps6ka3", "Src"))) %>% left_join(., genes, by="geneID")

DotPlot(seuratFb, features = selGenes, group.by= "cond2_plus_cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond2") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
DotPlot(seuratFb, features = selGenes, group.by= "cond3") + RotatedAxis() + scale_color_viridis(option="E") + coord_flip()
```

#### session info
```{r date and session info}
date()
sessionInfo()
```
